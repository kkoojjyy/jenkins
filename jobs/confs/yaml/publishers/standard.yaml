- publisher:
    name: standard-publisher
    publishers:
      - post-tasks:
          - matches:
              - log-text: '.*'
                operator: AND
            escalate-status: true
            script: !include-raw-escape: shell-scripts/collect_artifacts.sh
          - matches:
              - log-text: '.*'
                operator: AND
            escalate-status: true
            script: !include-raw-escape: shell-scripts/mock_cleanup.sh
      - exported-artifacts
      - groovy-postbuild:
          script: |
            def project = manager.build.project
            def index_fd = project.getWorkspace().child("exported-artifacts/index.html")
            if (index_fd.exists()) {{
              summary = manager.createSummary("graph.png")
              summary.appendText(
                '<iframe src="artifact/exported-artifacts/index.html" width=600 height=400>Report</iframe>',
                false,
              )
            }}
            def container_details = manager.build.getWorkspace().child("exported-artifacts/pushed_container_images.lst")
            if (container_details.exists()) {{
                String img_details = container_details.readToString()
                def regex_matcher = img_details =~ /(.+\/.+):(.+)/
                String repo = regex_matcher[0][1]
                String image_id = regex_matcher[0][2]
                String msg = "<pre><span style='background-color: #F2F2F2; color: #424242;'>" +
                    "<b>Exported docker image details</b><br>" +
                    "Image ID:   $image_id<br>" +
                    "Repository: $repo<br>" +
                    "Docker PULL: docker pull $img_details" +
                    "Docker RUN:  docker run $img_details" +
                    "</pre>"
                container_summary = manager.createSummary("package.png")
                container_summary.appendText(msg, false)
            }}
          on-failure: 'nothing'
      - raw: # the current stable version of jjb (1.6) does not support
             # 'allow-empty-results' in the junit plugin (added in 2.0),
             # so I had to include raw xml to make work
          xml: |
            <hudson.tasks.junit.JUnitResultArchiver plugin="junit@1.14">
              <testResults>exported-artifacts/**/*.junit.xml,
              exported-artifacts/**/nosetests*</testResults>
              <keepLongStdio>true</keepLongStdio>
              <healthScaleFactor>1.0</healthScaleFactor>
              <allowEmptyResults>true</allowEmptyResults>
            </hudson.tasks.junit.JUnitResultArchiver>
      - conditional-publisher:
          - condition-kind: shell
            condition-command: >
                find exported-artifacts/find-bugs/ -name "*.xml" | grep -e ".*"
            action:
                - findbugs:
                    pattern: 'exported-artifacts/find-bugs/*.xml'
                    rank-priority: true
                    thresholds:
                        unstable:
                            total-all: 0

- publisher:
    name: 'build-artifacts_publisher-when_on-change'
    publishers: {}

- publisher:
    name: 'build-artifacts_publisher-when_timed'
    publishers:
      - trigger-parameterized-builds:
        - project: 'deploy-to_ovirt-{version}_tested'
          predefined-parameters: |
            REPOMAN_SOURCES=$BUILD_URL
          condition: SUCCESS
      - email-ext:
          recipients: '{email-to}'
          failure: true
          fixed: true
          unstable: true
